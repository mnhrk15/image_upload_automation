## **HotPepperBeautyスタイル画像 GoogleMap自動投稿アプリ 要件定義書 (最終版)**

### 1. 概要

**1.1. アプリの目的**
ユーザーが指定した美容室のHotPepperBeauty（HPB）のトップページURLと、対象Googleビジネスプロフィール（GBP）の写真投稿画面URLに基づき、HPBから最新のヘアスタイル画像を取得・選択し、指定されたGBPに自動で投稿することにより、GBPコンテンツの更新作業を効率化する**デスクトップアプリケーション**を提供する。

**1.2. 主な機能**
*   ユーザーがGUIを通じて、HPBサロントップページのURLとGBP写真投稿画面のURLを入力する。
*   HPBから最新スタイル画像（最大10枚、重複除く）を取得・ダウンロードする。
*   取得した画像をGUI上に表示し、ユーザーが投稿する画像を選択する。
*   Playwrightを使用し、`storage_state`によるGoogleアカウント認証を用いて、選択された画像をユーザー指定のGBP写真投稿画面URLに投稿する。
*   処理の状況、結果、エラーをGUI上に分かりやすく表示する。

### 2. 機能要件

**2.1. 入力機能 (デスクトップGUI)**
*   アプリケーションのGUIを通じて、以下の情報をユーザーが入力・設定できる。
    *   **HPBトップページURL:** 処理対象となる美容室のHPBトップページのURL (例: `https://beauty.hotpepper.jp/slnH000xxxxxx/`)。
    *   **GBP写真投稿画面URL:** 投稿先となるGBPの写真追加が可能なページのURL。ユーザーが事前にブラウザで確認・特定しておく必要がある。

**2.2. HPBスクレイピング機能**
*   **前提:** 本機能は、外部設定ファイル([3.9](#39-設定ファイル)参照)に定義された**HPB関連セレクタ**に基づいて実装される。
*   **サロン名取得:** HPBトップページURLからサロン名を取得する（表示用）。
*   **スタイルページ特定:** HPBトップURLからスタイルページのベースURLを生成する。
*   **最大ページ数取得:** スタイルページから最大ページ数を抽出する。
*   **画像取得ロジック:**
    *   スタイルページの最後のページから1ページ目に向かって順にアクセスする。
    *   各ページからスタイル画像の`<img>`要素を取得する。
    *   各要素の`src`属性から高解像度画像URL（クエリパラメータ除去後）を生成する。
    *   取得したURLをリストに保持し、URL文字列での重複を排除する。
    *   ユニークなURLが10件になるまで、または1ページ目まで遡るまで処理を続ける。
*   **画像ダウンロード:** 取得したユニークな高解像度画像URLから、画像データをダウンロードし、アプリケーションの一時ディレクトリに保存する。

**2.3. 画像選択UI機能 (デスクトップGUI)**
*   2.2でダウンロードした画像（最大10枚）を、アプリケーションウィンドウ内に**サムネイル画像**として一覧表示する。
*   各サムネイルには**チェックボックス**を表示し、ユーザーがGBPに投稿したい画像を選択（または選択解除）できるようにする。デフォルトでは全画像が選択状態とする。
*   「選択した画像を投稿」ボタンを配置し、ユーザーが画像選択を確定し投稿プロセスを開始できるようにする。このボタンは画像取得後に有効化される。

**2.4. GoogleMap（GBP）投稿機能 (デスクトップGUI & Playwright)**
*   **投稿先:** 2.1でユーザーが入力した**GBP写真投稿画面URL**。
*   **投稿方法:**
    *   **ブラウザ起動と認証:**
        *   Playwrightを使用し、新しいブラウザインスタンスを起動する（非ヘッドレスモード選択可能推奨）。
        *   **`storage_state`による認証:** アプリケーションはローカルの`storage_state`ファイルを読み込み、ログイン状態を復元する。無効な場合はユーザーに手動ログインを促し、成功後に`storage_state`を保存する。
    *   **ページアクセス:** Playwrightで、2.1で入力された**GBP写真投稿画面URL**に直接アクセスする。
    *   **写真投稿操作:**
        *   アクセスしたページ上で、外部設定ファイル([3.9](#39-設定ファイル)参照)に定義された**GBP写真投稿関連セレクタ**に基づき、写真追加ボタンのクリック（必要な場合）、ファイル選択要素の特定、投稿完了ボタンのクリック等をPlaywrightで実行する。
        *   ファイル選択要素に対し、2.3でユーザーが選択した画像ファイルのパスを、Playwrightのファイル選択機能 (`setInputFiles`) を用いて設定（アップロード）する。
*   **投稿内容:** 2.3でユーザーが選択した画像ファイルのみを投稿する。キャプション等は付与しない。

**2.5. 重複排除機能**
*   **URL重複:** HPBからの画像URL取得時に、システムがURL文字列の完全一致で重複を排除する。
*   **画像内容重複:** システムは判定しない。2.3の画像選択UIでユーザーが判断し、不要な画像のチェックを外す。

**2.6. ユーザーインターフェース (デスクトップGUI)**
*   PythonのGUIツールキット**`PyQt6`** を使用して開発された、単一ウィンドウのデスクトップアプリケーション。
*   **画面構成:**
    *   HPBトップURL入力欄。
    *   GBP写真投稿画面URL入力欄。
    *   「Googleにログイン/状態確認」ボタン/表示。
    *   「画像を取得」ボタン。
    *   取得画像サムネイル一覧表示エリア（スクロール可能、チェックボックス付き）。
    *   「選択した画像を投稿」ボタン（画像取得後に有効化）。
    *   処理状況や結果を表示するステータスバーまたはスクロール可能なテキストエリア。
    *   メニューバー（ヘルプ[使い方、`storage_state`の説明]、終了）。

### 3. 非機能要件

**3.1. 実行環境**
*   Windows 10/11
*   macOS (11 Big Sur以降推奨)
*   Python 3.9 以降
*   必要なPythonライブラリ ([3.2](#32-使用技術言語)参照)

**3.2. 使用技術/言語**
*   プログラミング言語: **Python 3.9** 以降
*   GUIツールキット: **PyQt6**
*   ブラウザ自動操作: **Playwright for Python**
*   Webスクレイピング補助: **Requests**, **BeautifulSoup4**
*   **非同期処理/マルチスレッド:** GUI応答性維持のためバックグラウンド実行 (`asyncio` または `threading`)。

**3.3. 認証方式（Googleアカウント）**
*   **Playwrightの `storage_state` 機能**を利用。
*   `storage_state`ファイルをローカルに保存・読み込み。
*   `storage_state`が無効になった場合の再ログインフローを提供。

**3.4. エラーハンドリング**
*   全ての処理での例外を捕捉し、GUIに分かりやすいエラーメッセージを表示。
*   HPB/Googleの仕様変更によるエラー（要素が見つからない等）の場合は、具体的な箇所を示す。
*   エラー発生時は原則として処理を中断。
*   詳細なエラーログファイル生成機能。

**3.5. 結果通知**
*   処理の各ステップのステータスをGUIにリアルタイム表示。
*   最終的な処理結果（成功/失敗、投稿枚数）を明確に表示。

**3.6. 利用規約/ポリシー遵守**
*   HPB/Googleの利用規約・ポリシー遵守は**ユーザー責任**。自動化に関する規約をユーザーが確認・判断する必要がある。開発者は規約違反による損害の責任を負わない。

**3.7. パフォーマンス/安定性**
*   GUI応答性のためバックグラウンド処理を使用。
*   Playwright操作は対象サイトのUI変更に脆弱であり、定期的なメンテナンスが必要。
*   投稿処理間の待機時間（例: 3-5秒）を設定。

**3.8. セキュリティ**
*   `storage_state`ファイルにはGoogleアカウントのセッション情報が含まれるため、ファイルの保管場所とアクセス権限に注意が必要。ユーザーへの注意喚起を行う。

**3.9. 設定ファイル (新規)**
*   **セレクタ情報の外部化:** HPBおよびGBPの操作に使用する**CSSセレクタ**や**XPath**等の情報は、アプリケーションコード内には直接記述せず、**外部の設定ファイル**（例: `config.json`, `selectors.yaml`）で管理する。
*   **目的:** HPBやGoogle側のウェブサイト構造が変更された際に、アプリケーション本体のコードを修正することなく、**設定ファイルのみを更新**することで対応可能とし、メンテナンス性を向上させる。
*   アプリケーションは起動時にこの設定ファイルを読み込み、スクレイピングやPlaywright操作に利用する。

### 4. アプリ使用手順（想定）

1.  **初回セットアップ（または再ログイン時）:**
    *   アプリ起動 → ログイン要求表示 → 「Googleにログイン」ボタン → Playwrightブラウザで手動ログイン → `storage_state`自動保存 → ブラウザ閉じる。
2.  **通常利用:**
    *   アプリ起動 → HPB URL入力 → GBP写真投稿URL入力 → 「画像を取得」ボタン → サムネイル表示待機 → 投稿画像選択（チェック外す） → 「選択した画像を投稿」ボタン → ステータス確認 → 最終結果確認。
3.  **終了:** アプリケーションウィンドウを閉じる。

### 5. その他/考慮事項

*   **HPB/Googleの仕様変更リスク:** 最大のリスク。継続的メンテナンスが必須。**セレクタ情報を設定ファイルで管理**([3.9](#39-設定ファイル)参照)することにより、変更への対応を容易にする。
*   **依存ライブラリ:** PyQt6, Playwright, Requests, BeautifulSoup4等。`requirements.txt`とインストール手順を提供。
*   **実行可能ファイル化:** PyInstaller等での配布を強く推奨。
*   **`storage_state` の有効期限:** 定期的な再ログインが必要になる可能性あり。
*   **GUIデザイン:** PyQt6の機能を活用し、使いやすさを向上させる。
*   **設定の保存:** 入力URLの次回起動時への保持（オプション）。

### 6. 指定セレクタ情報 (外部設定ファイルで管理)

**注意:** 以下のセレクタは例であり、実際の値は外部設定ファイル（例: `config.json`）に記述される。これらのセレクタはHPBおよびGoogleのUI変更により**頻繁に無効になる可能性**があるため、定期的な確認と設定ファイルの更新が必要。

**6.1. HotPepper Beauty 関連 (例)**
*   `hpb_salon_name_selector`: "#mainContents > div.detailHeader.cFix.pr > div > div.pL10.oh.hMin120 > div > p.detailTitle > a"
*   `hpb_max_page_element_selector`: "#mainContents > div.mT20 > div.pH10.mT25.pr > p.pa.bottom0.right0"
*   `hpb_style_image_selector`: "#jsiHoverAlphaLayerScope img.bdImgGray"
*   `hpb_image_url_cleanup_rule`: `?impolicy=`以降を除去 (これはルールなので設定ファイルよりコード実装か)

**6.2. Google Business Profile (GBP) 写真投稿関連 (例)**
*   `gbp_add_photo_button_selector`: "#media_result_group a:has-text('写真を追加')" (*より堅牢なセレクタに変更*)
*   `gbp_upload_modal_selector`: "#yDmH0d > c-wiz > div > div > div > main > div > div > div > div.AuK8vc"
*   `gbp_file_input_selector`: 'input[type="file"][jsname="qGt1Bf"]' (*より具体的な属性で指定*)
*   `gbp_post_button_selector`: `button:has-text("投稿")` (*投稿完了ボタンの例、要検証*)
